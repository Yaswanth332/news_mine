{% load static %}
{% extends 'recommendation/base.html' %}
{% block title %}Get Crop Recommendations | Crop Selector{% endblock %}

{% block extra_head %}
<style>
    /* New styles for multi-step form and enhanced aesthetics */
    :root {
        --form-step-indicator-bg: #e9ecef;
        --form-step-indicator-active-bg: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
        --form-step-indicator-text: #6c757d;
        --form-step-indicator-active-text: #fff;
        --form-card-bg: rgba(255, 255, 255, 0.98);
        --form-card-border: rgba(0, 0, 0, 0.1);
        --form-card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        --form-input-bg: rgba(248, 249, 250, 0.8);
        --form-input-border: rgba(0, 0, 0, 0.15);
        --form-input-focus-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
    }

    [data-bs-theme="dark"] {
        --form-step-indicator-bg: #495057;
        --form-step-indicator-active-bg: linear-gradient(135deg, #388E3C 0%, #689F38 100%);
        --form-step-indicator-text: #dee2e6;
        --form-step-indicator-active-text: #fff;
        --form-card-bg: rgba(33, 37, 41, 0.95);
        --form-card-border: rgba(255, 255, 255, 0.1);
        --form-card-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        --form-input-bg: rgba(52, 58, 64, 0.7);
        --form-input-border: rgba(255, 255, 255, 0.15);
        --form-input-focus-shadow: 0 0 0 0.25rem rgba(139, 195, 74, 0.35);
    }

    .recommendation-form-section {
        min-height: 80vh;
        display: flex;
        align-items: center;
        padding: 4rem 0;
        position: relative;
        overflow: hidden;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.8) 0%, rgba(240, 240, 240, 0.8) 100%);
        background-size: cover;
        background-position: center;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    [data-bs-theme="dark"] .recommendation-form-section {
        background: linear-gradient(180deg, rgba(17, 24, 39, 0.85) 0%, rgba(30, 41, 59, 0.85) 100%);
        background-size: cover;
        background-position: center;
    }

    .form-container-custom {
        max-width: 800px;
        margin: 0 auto;
        background: var(--form-card-bg);
        border-radius: 20px;
        box-shadow: var(--form-card-shadow);
        border: 1px solid var(--form-card-border);
        overflow: hidden;
        animation: fadeInUp 0.8s ease-out;
    }

    .form-header-custom {
        background: var(--form-step-indicator-active-bg); /* Use the same gradient as active step */
        color: var(--form-step-indicator-active-text);
        padding: 2rem 1.5rem;
        text-align: center;
        position: relative;
    }

    .form-header-custom h2 {
        font-family: 'Plus Jakarta Sans', sans-serif;
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 2.2rem;
    }

    .form-header-custom p {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .form-steps {
        display: flex;
        justify-content: center;
        padding: 1.5rem 1rem;
        background: var(--form-step-indicator-bg);
        border-bottom: 1px solid var(--form-card-border);
    }

    .form-step-item {
        flex: 1;
        text-align: center;
        cursor: pointer;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
        position: relative;
        color: var(--form-step-indicator-text);
        font-weight: 600;
        font-size: 0.95rem;
        margin: 0 0.5rem;
    }

    .form-step-item.active {
        background: var(--form-step-indicator-active-bg);
        color: var(--form-step-indicator-active-text);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        transform: translateY(-3px);
    }

    .form-step-item:hover:not(.active) {
        background: rgba(var(--primary-color-rgb), 0.1);
        color: var(--primary-color);
    }
    
    .form-step-item .step-icon {
        font-size: 1.2rem;
        margin-right: 0.5rem;
    }

    .form-body-custom {
        padding: 2rem;
        position: relative;
        overflow: hidden; /* For slide animation */
    }

    .form-step-content {
        display: none;
        animation: fadeIn 0.5s ease-out;
    }

    .form-step-content.active {
        display: block;
    }

    .form-group-custom {
        margin-bottom: 1.5rem;
    }

    .form-label-custom {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        display: block;
        font-size: 1.05rem;
    }

    .form-control-custom, .form-select-custom {
        border-radius: 10px;
        border: 1px solid var(--form-input-border);
        padding: 0.75rem 1rem;
        font-size: 1rem;
        background: var(--form-input-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
    }

    .form-control-custom::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }

    .form-control-custom:focus, .form-select-custom:focus {
        border-color: var(--primary-color);
        box-shadow: var(--form-input-focus-shadow);
        background: var(--form-card-bg); /* A bit brighter on focus */
        transform: translateY(-1px);
    }

    [data-bs-theme="dark"] .form-control-custom:focus, [data-bs-theme="dark"] .form-select-custom:focus {
        background: var(--form-input-bg);
    }

    .input-group-text-custom {
        background: rgba(76, 175, 80, 0.1);
        border: 1px solid var(--form-input-border);
        color: var(--primary-color);
        border-radius: 10px 0 0 10px;
    }
    [data-bs-theme="dark"] .input-group-text-custom {
        background: rgba(139, 195, 74, 0.15);
    }

    .btn-custom {
        background: var(--primary-gradient);
        border: none;
        border-radius: 50px;
        font-weight: 600;
        padding: 0.8rem 2rem;
        font-size: 1rem;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.35);
    }

    .btn-custom:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(76, 175, 80, 0.45);
        color: white;
    }

    .btn-outline-custom {
        border-radius: 50px;
        font-weight: 600;
        padding: 0.8rem 2rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
    }

    .btn-outline-custom:hover {
        transform: translateY(-3px);
        background: rgba(76, 175, 80, 0.1);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.2);
        color: var(--primary-color);
    }

    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
    }

    /* Animations */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(50px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOutLeft {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(-50px); }
    }
    @keyframes slideInLeft {
        from { opacity: 0; transform: translateX(-50px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOutRight {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(50px); }
    }

    /* Specific animations for form steps */
    .slide-enter-active { animation: slideInRight 0.6s ease-out forwards; }
    .slide-leave-active { animation: slideOutLeft 0.6s ease-out forwards; position: absolute; width: 100%; top: 0; left: 0;} /* Important for smooth overlap */

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .form-steps {
            flex-direction: column;
            align-items: center;
        }
        .form-step-item {
            width: 90%;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        .form-body-custom {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="recommendation-form-section" style="background-image: linear-gradient(180deg, rgba(255, 255, 255, 0.8) 0%, rgba(240, 240, 240, 0.8) 100%), url('{{ background_image_url }}');">
    <div class="container">
        <div class="form-container-custom">
            <div class="form-header-custom">
                <h2>Optimize Your Harvest!</h2>
                <p>Provide your field details for expert crop recommendations.</p>
            </div>

            <div class="form-steps" id="formStepsNav">
                <div class="form-step-item active" data-step="1">
                    <span class="step-icon">üå±</span>Soil Info
                </div>
                <div class="form-step-item" data-step="2">
                    <span class="step-icon">üå¶Ô∏è</span>Climate Data
                </div>
                <div class="form-step-item" data-step="3">
                    <span class="step-icon">üìÖ</span>Planning
                </div>
            </div>

            <div class="form-body-custom">
                <form method="POST" novalidate id="cropRecommendationForm">
                    {% csrf_token %}
                    {{ form.non_field_errors }}

                    <!-- Step 1: Soil Information -->
                    <div class="form-step-content active" data-step="1">
                        <div class="row g-3">
                            <div class="col-md-6 form-group-custom">
                                <label for="{{ form.soil_texture.id_for_label }}" class="form-label-custom">
                                    Soil Texture
                                </label>
                                {{ form.soil_texture|add_class:"form-select-custom" }}
                                {% if form.soil_texture.help_text %}<div class="form-text">{{ form.soil_texture.help_text }}</div>{% endif %}
                                {% if form.soil_texture.errors %}<div class="text-danger small">{{ form.soil_texture.errors|striptags }}</div>{% endif %}
                            </div>
                            <div class="col-md-6 form-group-custom">
                                <label for="{{ form.soil_ph.id_for_label }}" class="form-label-custom">
                                    Soil pH
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text-custom"><i class="fas fa-balance-scale"></i></span>
                                    {{ form.soil_ph|add_class:"form-control-custom" }}
                                </div>
                                <div class="form-text">Typical range: 4.0-9.0 (7.0 is neutral)</div>
                                {% if form.soil_ph.errors %}<div class="text-danger small">{{ form.soil_ph.errors|striptags }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6 form-group-custom">
                                <label for="{{ form.organic_matter.id_for_label }}" class="form-label-custom">
                                    Organic Matter Level
                                </label>
                                {{ form.organic_matter|add_class:"form-select-custom" }}
                                {% if form.organic_matter.errors %}<div class="text-danger small">{{ form.organic_matter.errors|striptags }}</div>{% endif %}
                            </div>
                            <div class="col-md-6 form-group-custom">
                                <label for="{{ form.drainage_status.id_for_label }}" class="form-label-custom">
                                    Drainage Status
                                </label>
                                {{ form.drainage_status|add_class:"form-select-custom" }}
                                {% if form.drainage_status.errors %}<div class="text-danger small">{{ form.drainage_status.errors|striptags }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="navigation-buttons">
                            <button type="button" class="btn btn-outline-custom" disabled>Previous</button>
                            <button type="button" class="btn btn-custom" data-next-step>Next: Climate Data</button>
                        </div>
                    </div>

                    <!-- Step 2: Climate Information -->
                    <div class="form-step-content" data-step="2">
                        <div class="row g-3">
                            <div class="col-md-6 form-group-custom">
                                <label for="{{ form.rainfall_mm.id_for_label }}" class="form-label-custom">
                                    Average Annual Rainfall
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text-custom"><i class="fas fa-cloud-rain"></i></span>
                                    {{ form.rainfall_mm|add_class:"form-control-custom" }}
                                    <span class="input-group-text-custom">mm</span>
                                </div>
                                <div class="form-text">Annual rainfall in millimeters</div>
                                {% if form.rainfall_mm.errors %}<div class="text-danger small">{{ form.rainfall_mm.errors|striptags }}</div>{% endif %}
                            </div>
                            <div class="col-md-6 form-group-custom">
                                <label for="{{ form.avg_temperature.id_for_label }}" class="form-label-custom">
                                    Average Temperature
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text-custom"><i class="fas fa-thermometer-half"></i></span>
                                    {{ form.avg_temperature|add_class:"form-control-custom" }}
                                    <span class="input-group-text-custom">¬∞C</span>
                                </div>
                                <div class="form-text">Average temperature during growing season</div>
                                {% if form.avg_temperature.errors %}<div class="text-danger small">{{ form.avg_temperature.errors|striptags }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="navigation-buttons">
                            <button type="button" class="btn btn-outline-custom" data-prev-step>Previous: Soil Info</button>
                            <button type="button" class="btn btn-custom" data-next-step>Next: Planning</button>
                        </div>
                    </div>

                    <!-- Step 3: Crop Planning -->
                    <div class="form-step-content" data-step="3">
                        <div class="row g-3">
                            <div class="col-md-6 form-group-custom">
                                <label for="{{ form.season.id_for_label }}" class="form-label-custom">
                                    Current Season
                                </label>
                                {{ form.season|add_class:"form-select-custom" }}
                                {% if form.season.errors %}<div class="text-danger small">{{ form.season.errors|striptags }}</div>{% endif %}
                            </div>
                            <div class="col-md-6 form-group-custom">
                                <label for="{{ form.previous_crop.id_for_label }}" class="form-label-custom">
                                    Previous Crop (Optional)
                                </label>
                                {{ form.previous_crop|add_class:"form-select-custom" }}
                                <div class="form-text">Helps with crop rotation recommendations</div>
                                {% if form.previous_crop.errors %}<div class="text-danger small">{{ form.previous_crop.errors|striptags }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="navigation-buttons">
                            <button type="button" class="btn btn-outline-custom" data-prev-step>Previous: Climate Data</button>
                            <button type="submit" class="btn btn-custom" id="submitBtn">
                                <span class="spinner-border spinner-border-sm me-2 d-none" id="submitSpinner"></span>
                                Get My Recommendations
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formStepsNav = document.getElementById('formStepsNav');
    const formStepItems = formStepsNav.querySelectorAll('.form-step-item');
    const formStepContents = document.querySelectorAll('.form-step-content');
    const form = document.getElementById('cropRecommendationForm');
    let currentStep = 1;

    function showStep(step) {
        // Deactivate all step items and contents
        formStepItems.forEach(item => item.classList.remove('active'));
        formStepContents.forEach(content => {
            content.classList.remove('slide-enter-active', 'slide-leave-active');
            content.style.display = 'none'; // Ensure it's hidden before animation
        });

        // Activate current step item and content
        const activeStepItem = document.querySelector(`.form-step-item[data-step="${step}"]`);
        const activeStepContent = document.querySelector(`.form-step-content[data-step="${step}"]`);
        
        if (activeStepItem) activeStepItem.classList.add('active');
        if (activeStepContent) {
            // Apply slide-in animation
            activeStepContent.style.display = 'block';
            activeStepContent.classList.add('slide-enter-active');
            currentStep = step;
        }
    }

    function goToNextStep() {
        if (validateCurrentStep()) {
            const nextStep = currentStep + 1;
            if (nextStep <= formStepContents.length) {
                // Apply slide-out animation to current step
                const currentContent = document.querySelector(`.form-step-content[data-step="${currentStep}"]`);
                if (currentContent) {
                    currentContent.classList.add('slide-leave-active');
                    currentContent.addEventListener('animationend', () => {
                        currentContent.style.display = 'none';
                        showStep(nextStep);
                    }, { once: true });
                } else {
                    showStep(nextStep); // Fallback if no animation
                }
            }
        }
    }

    function goToPrevStep() {
        const prevStep = currentStep - 1;
        if (prevStep >= 1) {
            // No slide-out needed for previous, directly show prev
            const currentContent = document.querySelector(`.form-step-content[data-step="${currentStep}"]`);
            if (currentContent) {
                currentContent.classList.remove('slide-enter-active'); // Remove any lingering enter animation
                currentContent.style.display = 'none';
            }
            showStep(prevStep); // Simply show the previous step, it will slide in from left
        }
    }

    function validateCurrentStep() {
        const currentContent = document.querySelector(`.form-step-content[data-step="${currentStep}"]`);
        if (!currentContent) return false;

        let isValid = true;
        const inputs = currentContent.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (!input.checkValidity()) {
                isValid = false;
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
            } else {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
            }
        });
        return isValid;
    }

    // Attach event listeners to navigation buttons
    document.querySelectorAll('[data-next-step]').forEach(button => {
        button.addEventListener('click', goToNextStep);
    });

    document.querySelectorAll('[data-prev-step]').forEach(button => {
        button.addEventListener('click', goToPrevStep);
    });

    // Attach event listeners to step navigation items
    formStepItems.forEach(item => {
        item.addEventListener('click', function() {
            const step = parseInt(this.dataset.step);
            if (step < currentStep) { // Allow going back without validation
                 // Apply slide-out animation to current step before switching to previous
                const currentContent = document.querySelector(`.form-step-content[data-step="${currentStep}"]`);
                if (currentContent) {
                    currentContent.classList.add('slide-leave-active');
                    currentContent.addEventListener('animationend', () => {
                        currentContent.style.display = 'none';
                        showStep(step);
                    }, { once: true });
                } else {
                    showStep(step);
                }
            } else if (step > currentStep) {
                // If trying to go forward, validate current step
                if (validateCurrentStep()) {
                     // Apply slide-out animation to current step
                    const currentContent = document.querySelector(`.form-step-content[data-step="${currentStep}"]`);
                    if (currentContent) {
                        currentContent.classList.add('slide-leave-active');
                        currentContent.addEventListener('animationend', () => {
                            currentContent.style.display = 'none';
                            showStep(step);
                        }, { once: true });
                    } else {
                        showStep(step);
                    }
                }
            }
        });
    });

    // Handle form submission with loading state
    form.addEventListener('submit', function(event) {
        if (!validateCurrentStep()) {
            event.preventDefault(); // Stop submission if validation fails
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        const spinner = document.getElementById('submitSpinner');
        
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing Your Field...';
    });

    // Initial display for the first step
    showStep(currentStep);
});
</script>
{% endblock %}